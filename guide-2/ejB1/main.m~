%%
%%Variables and constants:
clear all;
tresh = 0.1;
dif = 99999999;

cantBars = 2;
barWidth = 10;
sysWidth = (2*cantBars+1)*barWidth;
sysHeight = 15;
N = sysWidth*sysHeight; %Matrix size
Tamb = 30;
Tcpu = 60;


%Matrices.
A = zeros(N,N);
B = zeros(N);
X = zeros(N);

idx = 0;
for i = 1: sysHeight
    for j = 1:sysWidth
        
        idx = idx +1;

        
        if i == 0
            A(idx,idx) = 1;
            B(idx) = Tamb;
            map(i,j) = Tamb;
            continue
        end

        if i == sysHeight
            A(idx,idx) = 1;
            B(idx) = Tcpu;
            map(i,j) = Tcpu;
            continue
        end
        

        
        if rem(j,2*barWidth) <= barWidth
            A(idx,idx) = 1;
            B(idx) = Tamb;
            map(i,j) = 1;
            continue
        end
        
        if (rem(j,2*barWidth) > barWidth) || ( i >= sysHeight-2 && i < sysHeight && j > 0 && j < sysWidth)
            A(idx,idx) = 4;
            if idx-1 > 1
            A(idx,idx-1) = -1;
            end
            if idx+1 < N
            A(idx,idx+1) = -1;
            end
            if idx - sysWidth > 1
            A(idx,idx-sysWidth) = -1;
            end
            if idx + sysWidth < N
            A(idx,idx+sysWidth) = -1;
            end
            B(idx) = 0;
            map(i,j) = 0;
            continue
        end



    end
end


%A


%%
%%DLU decomposition:

[m,n] = size(A); %TODO: m should be equal to n anyway, right?
D = zeros(N,N);
L = zeros(N,N);
U = zeros(N,N);

for i = 1:N
    for j = 1:N
        if i == j
            D(i,j) = A(i,j);
        end
        if i > j
            L(i,j) = -A(i,j);
        end
        if i < j
            U(i,j) = -A(i,j);
        end
    end
end


%(D-L)^(-1)
DmLi = inv(D-L);
%%
%%Method matrices:
idx = 1;


E = DmLi*U;
C = DmLi*B;

%%Spectral Radii of E (if < 1, the method had convergence).
eigE = eig(E);
pE = max([abs(max(eigE)) abs(min(eigE))]);
disp('Spectral radii pE. If pE<1, the method converges.');

pE;

while dif > tresh
   old = X;
   X = E*X + C;
   
   dif = norm(X - old);   
   conv(idx) = dif;
   idx = idx+1;
end

plot(conv);
figure


%%
%%Making the physical map.
idx = 0;
for i = 1:sysHeight
    for j = 1:sysWidth
        idx = idx+1;
        S(i,j) = X(idx);
    end
end
S
%
mesh(S)
HeatMap(S)

%%
%%Checking result:
%disp('If the solution is correct DBG should be near zero.')
%DBG = X - A\B
